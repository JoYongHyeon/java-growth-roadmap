## 동시성 문제
같은 자원(리소스)에 여러 스레드가 동시에 접근할 때 발생하는 문제.
참고로 여러 스레드가 접근하는 자원을 **공유 자원** 이라 한다.
대표적인 공유 자원은 인스턴스의 필드이다.
멀티스레드를 사용할 때는 이런 공유 자원에 대한 접근을 적절하게 `동기화(synchronized)`해서 동시성 문제가 발생하지 않게
방지하는 것이 중요하다.

## 임계 영역
`Account_V1_Main` 의 결과 값 처럼 이런 문제가 발생하는 근본적인 원인은
여러 스레드가 함께 사용하는 공유 자원을 여러 단계로 나누어 사용하기 때문이다.

**1. 검증 단계: 잔액이 출금액 보다 많은지 확인**

**2. 출금 단계: 잔액을 출금액 만큼 줄인다.**

```
09:17:19.071 [       t1] 거래 시작: Account_V1_Impl
09:17:19.071 [       t2] 거래 시작: Account_V1_Impl
09:17:19.076 [       t1] [검증 시작] 출금액: 800, 잔액: 1000
09:17:19.076 [       t2] [검증 시작] 출금액: 800, 잔액: 1000
09:17:19.076 [       t2] [검증 완료] 출금액: 800, 잔액: 1000
09:17:19.076 [       t1] [검증 완료] 출금액: 800, 잔액: 1000
09:17:19.563 [     main] t1 state: TIMED_WAITING
09:17:19.563 [     main] t2 state: TIMED_WAITING
09:17:20.082 [       t2] [출금 완료] 출금액: 800, 변경 잔액: 200
09:17:20.083 [       t2] 거래 종료
09:17:20.082 [       t1] [출금 완료] 출금액: 800, 변경 잔액: -600
09:17:20.083 [       t1] 거래 종료
09:17:20.083 [     main] 최종 잔액: -600
```

```java
    @Override
    public boolean withdraw(int money) {
        log("거래 시작: " + getClass().getSimpleName());

        log("[검증 시작] 출금액: " + money + ", 잔액: " + balance);

        // 1. 검증 단계
        if (balance < money) {
            log("[검증 실패] 출금액: " + money + ", 잔액: " + balance);
            return false;
        }
        log("[검증 완료] 출금액: " + money + ", 잔액: " + balance);
        sleep(1000);
        
        // 2. 출금 단계
        balance -= money;
        log("[출금 완료] 출금액: " + money + ", 변경 잔액: " + balance);

        log("거래 종료");
        return true;
    }
```
스레드의 관점에서 보면 검증 단계에서 확인한 잔액이 출금해야 하는 금액보다
많은 경우에만 출금 단계를 진행할 수 있다.
그런데 또 다른 스레드가 중간에 잔액의 값을 변경한다면, 문제가 발생한다.
1000원 이라고 생각한 잔액이 다른 값으로 변경되면 잔액이 전혀 다른 값으로 계산될 수 있다.

## 공유 자원
Accountj_V1_Main 클래스를 보면 `balance`의 값은
여러 스레드가 함께 사용하는 공유 자원이다.
따라서 하나의 스레드가 출금 로직을 수행하는 중간에 다른 스레드에서
이 값을 얼마든지 변경할 수 있다.

## 해결 방법
해결 방법은 간단하다.
한 번에 하나의 스레드만 실행하면 된다.
만약 출금이라는 메서드를 한 번에 하나의 스레드만 실행할 수 있게 제한한다면
중간에 다른 스레드가 `balance`의 값을 변경하는 부분도 걱정하지 않아도 된다.
---
### 임계 영역
영어로 `크리티컬 섹션`이라 한다.
- 여러스레드가 동시에 접근하면 데이터 불일치나 예상치 못한 동작이 발생할 수 있는 위험하고 또
  중요한 코드 부분을 뜻한다.
- 여러 스레드가 동시에 접근해서는 안되는 공유 자원을 접근하거나 수정하는 부분을 의미한다.

위의 소스 부분이 바로 `임계 영역`이다.
---
